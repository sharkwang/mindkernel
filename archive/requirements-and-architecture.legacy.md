# requirements-and-architecture.legacy.md（整理版）

> 说明：该文档是从 `memory-v2` 迁移过来的历史设计草案集合。已按主题重整导航，内容保持原样，作为**只读归档**。

## 快速导航（按主题）

- **A. 基础需求与架构底稿**：§1-§13（问题定义、需求、架构、治理、指标）
- **B. 概念升级讨论**：§14-§17（事件中心、同构/异构、双边界、人格-认知-记忆）
- **C. 可执行与风险治理**：§18-§24（规范、Experience 闸门、社会认知、反欺骗、反偏执、情绪回路、闭环审查）

## 使用方式

1. 本文档仅用于追溯历史讨论，不再作为当前主规范。
2. 当前主规范迁移到：`docs/requirements-and-architecture.md`。
3. 任何新增设计请写入主规范，避免继续在 legacy 里追加。

---

## 原始标题（保留）

# Memory v2 需求与架构设计（草案 v0.1）

> 目标：先统一“要解决什么问题 + 系统长什么样”，再谈实现细节。

---

## 1. 背景与问题定义

当前记忆体系在“可用性、可靠性、可解释性”上存在明显缺口：

1. **记忆写入不确定**：重要信息在对话后不一定沉淀到长期记忆。
2. **记忆类型混杂**：偏好、决策、上下文、任务状态放在同类文本中，难以治理。
3. **检索可解释性弱**：命中结果无法稳定追溯到来源会话/来源行。
4. **生命周期缺失**：记忆缺少更新、过期、归档机制。
5. **评估体系缺失**：无法量化“这版记忆系统是否更好”。

**核心判断**：问题本质不是“向量检索能力弱”，而是“记忆数据工程缺少明确的产品化闭环”。

---

## 2. 设计目标（Goals）

### 2.1 业务目标

- 提升“昨日讨论可被准确回忆”的成功率。
- 让每条长期记忆具备来源与置信度，可人工审计。
- 降低错误记忆（幻觉式记忆）对对话质量的影响。

### 2.2 系统目标

- 建立统一的记忆对象模型（Memory Object Model）。
- 建立端到端闭环：**Capture → Normalize → Curate → Retrieve → Govern**。
- 支持“结构化存储 + 人类可读视图（Markdown）”双形态。
- 提供可回归评估集与指标面板。

### 2.3 非目标（当前阶段不做）

- 不追求复杂知识图谱推理。
- 不做跨用户共享记忆。
- 不做强自动化写入（默认保留人工确认环节）。

---

## 3. 需求定义

### 3.1 功能需求（FR）

- **FR-1 记忆采集**：从会话中提取候选记忆（candidate memories）。
- **FR-2 记忆结构化**：每条记忆必须包含类型、内容、来源、置信度、时间戳。
- **FR-3 记忆审核**：候选记忆可人工确认/拒绝/合并。
- **FR-4 记忆发布**：审核通过后进入长期记忆存储，并可导出 Markdown 视图。
- **FR-5 记忆检索**：按语义 + 关键词混合检索，支持来源回溯。
- **FR-6 记忆治理**：支持过期标记、冲突检测、版本记录。
- **FR-7 记忆解释**：回答时可附带来源引用与置信度提示。

### 3.2 非功能需求（NFR）

- **NFR-1 可追溯性**：100% 长期记忆需可追溯来源。
- **NFR-2 可审计性**：任何记忆状态变化必须有审计日志。
- **NFR-3 稳定性**：检索失败时可降级关键词检索。
- **NFR-4 安全性**：敏感信息可标记并限制外部场景召回。
- **NFR-5 可维护性**：schema 变更需兼容旧数据迁移。

---

## 4. 记忆领域模型（Domain Model）

### 4.1 记忆分层

1. **Episodic（情节记忆）**：近期事件、会话上下文、临时信息。
2. **Semantic（语义记忆）**：稳定偏好、长期约定、常识性事实。
3. **Operational（操作记忆）**：环境配置、工具约束、流程规则。

### 4.2 记忆对象（Memory Entry）核心字段

- `id`
- `layer`（episodic/semantic/operational）
- `type`（preference/decision/project/todo/...）
- `fact`（规范化陈述）
- `source`（path + line range + session ref）
- `confidence`（high/medium/low）
- `status`（candidate/active/stale/archived/rejected）
- `createdAt/updatedAt/lastVerifiedAt`
- `sensitivity`（public/private/restricted，可选）

### 4.3 冲突模型

当两条记忆满足同一“事实键”（如用户称呼、偏好）且值不一致时，触发冲突：

- 自动策略：新记忆进入 `candidate`，旧记忆标为 `stale-candidate`。
- 人工策略：确认后完成替换（旧记忆归档）。

---

## 5. 总体架构

## 5.1 逻辑组件

1. **Capture Engine**
   - 输入：会话消息流/会话摘要
   - 输出：候选记忆（candidate）

2. **Normalization Engine**
   - 统一记忆格式
   - 做去重键生成、冲突键生成

3. **Curation Engine**
   - 人工确认工作台（或文本流程）
   - 执行 accept/reject/merge/update

4. **Memory Store**
   - 结构化主存（JSONL/SQLite）
   - Markdown 视图层（可导出到 MEMORY.md）

5. **Retrieval Engine**
   - Hybrid Search（语义 + 关键词）
   - 结果重排（recency + confidence + layer 权重）

6. **Governance Engine**
   - 生命周期管理（stale/archive）
   - 审计日志与指标统计

### 5.2 数据流

1) 会话结束/关键事件触发 Capture  
2) 候选记忆进入 `candidate store`  
3) 审核通过后写入 `active store`  
4) 检索只读 active（可选读 stale 低权重）  
5) 周期任务执行清理与重评估

---

## 6. 存储与索引策略

### 6.1 存储分层

- **Raw Layer**：原始候选（不可覆盖，append-only）
- **Curated Layer**：已确认记忆（可版本化）
- **Projection Layer**：面向人类阅读的 MEMORY.md 视图

### 6.2 索引策略

- 语义索引：embedding（向量）
- 文本索引：关键词/BM25
- 元数据索引：type/layer/status/confidence/time

### 6.3 一致性策略

- Curated 作为单一事实源（SSOT）
- Markdown 为投影视图，不直接作为结构化源

---

## 7. 检索与回答策略

1. 查询理解：判断是否为“记忆型问题”（偏好、历史决策、TODO、时间点）
2. 检索阶段：Hybrid 召回 + 元数据过滤
3. 排序阶段：`score = semantic * a + keyword * b + confidence * c + recency * d`
4. 生成阶段：优先引用 high-confidence；低置信度需显式提示
5. 失败策略：若低置信度或冲突，明确说“我查到但不确定”

---

## 8. 生命周期治理

### 8.1 状态机

`candidate -> active -> stale -> archived`

另有：`candidate -> rejected`

### 8.2 触发规则

- 超过阈值时间未验证：active -> stale
- 新事实冲突且新事实确认：旧事实 active -> archived
- 明确无效：active/stale -> archived

### 8.3 审计日志

每次状态变更记录：
- 操作人/操作源
- 变更前后
- 时间
- 变更原因

---

## 9. 评估体系

### 9.1 核心指标

- **Recall@K（记忆问题）**：问题相关记忆是否被召回
- **Precision@K**：召回内容的相关度
- **Citation Coverage**：回答中带来源引用比例
- **Stale Error Rate**：使用过期记忆导致错误的比例
- **Memory Freshness**：active 记忆平均验证时长

### 9.2 测试集

建立三类回归样本：
- 用户画像类（称呼、偏好）
- 历史决策类（某次约定为何这样定）
- 任务状态类（项目进展、待办）

---

## 10. 安全与边界

- 默认只在主会话暴露长期个性化记忆。
- 群聊/跨上下文时，按 sensitivity 与 scope 过滤。
- 敏感记忆不主动外发；需显式授权。

---

## 11. 分阶段落地计划（Roadmap）

### Phase 1：模型与流程定型
- 确认 schema 与状态机
- 建立 candidate/curated 存储
- 做最小检索闭环

### Phase 2：治理与评估
- 冲突检测、过期治理、审计日志
- 建立回归测试与指标输出

### Phase 3：体验优化
- 审核工作台
- 自动建议与解释性增强

---

## 12. 设计评审待确认（你拍板）

1. **SSOT 是否确定为 Curated 结构化存储？**
2. **MEMORY.md 是否只做投影视图（不直接写主数据）？**
3. **candidate 默认是否必须人工确认后才能进 active？**
4. **冲突策略是否默认“新候选不自动覆盖旧 active”？**
5. **是否将 sensitivity 纳入第一版？**

---

## 13. 术语表

- Candidate：候选记忆，尚未确认
- Curated：已确认、可用于回答的记忆
- SSOT：Single Source of Truth，单一事实源
- Projection：由主数据导出的阅读视图（如 MEMORY.md）

---

## 14. 2026-02-14 对话纪要（问题重定义）

> 以下内容来自本次设计对话，作为需求与架构的上位约束。

### 14.1 方向修正

- 仅做“操作层优化”（如写入流程、按钮、脚本）不足以解决根本问题。
- 应优先回答“我们到底要构建什么样的记忆系统”。

### 14.2 核心观点（用户提出）

1. **人类记忆不是简单条目库**，而是以**事件、时间、关联**为中心。
2. 人类记忆以**遗忘**为核心机制，而非无限累积。
3. 记忆通过**场景化、多模态输入**不断精炼，最终形成情绪与认知。

### 14.3 设计推论（当前共识）

- Memory v2 的目标应从“事实存储”升级为“**事件驱动、时间原生、关联优先**的记忆系统”。
- 记忆单元不应只有 fact，还应包含：
  - 事件上下文（何时、谁、在什么场景）
  - 关联关系（与人/项目/决策/结果的关系）
  - 状态演化（变化前后）
- 系统默认应具备“遗忘/衰减”机制：
  - 低价值、未复用、未验证内容逐步降权或归档
  - 高价值、反复验证内容逐步巩固

### 14.4 概念模型升级（提案）

建议将当前模型扩展为四层：

1. **Trace 层**：原始痕迹（对话片段、文件变更、操作日志）
2. **Episode 层**：事件化记忆（一次讨论/决策/行动）
3. **Semantic 层**：稳定语义（偏好、约定、长期事实）
4. **Cognitive 层**：认知特征（风格、价值偏好、决策习惯）

并引入两条机制：
- **Forgetting（遗忘/衰减）**：默认机制
- **Consolidation（巩固/重构）**：由复用、验证、影响度驱动

### 14.5 对后续架构的影响

以下内容将进入下一版架构细化：

- 增加时间轴与事件图谱建模（Event / Entity / Relation）
- 引入记忆衰减函数（time × reuse × impact）
- 引入层级迁移规则（Trace → Episode → Semantic → Cognitive）
- 检索时优先返回“可叙事事件链”而非孤立句子

---

## 15. 人类与机器记忆：同构与异构原则（2026-02-14）

> 目的：明确 Memory v2 应该“向人类学习什么”，以及“必须保持机器特性什么”。

### 15.1 相同之处（同构能力）

1. **都需要压缩世界**
   - 无法全量保存，必须抽象、概括、提炼。

2. **都依赖关联网络**
   - 记忆不是孤立点，而是事件、人物、目标、结果之间的关系网。

3. **都需要可更新**
   - 新证据到来后，旧记忆应可修正，而不是永久静态。

4. **都受价值权重驱动**
   - 高影响、高复用、高相关内容应获得更高召回优先级。

5. **都需要情境化检索**
   - 同一事实在不同场景下含义不同，检索必须结合上下文。

### 15.2 不同之处（异构边界）

1. **人类是体验记忆，机器是表征记忆**
   - 人类基于身体/情绪/体验；机器基于文本、日志、向量等外显表征。

2. **人类遗忘是生物过程，机器遗忘是策略过程**
   - 机器可显式设计衰减、过期、归档规则。

3. **人类可容忍模糊，机器必须可审计**
   - 机器需要明确来源、时间、变更历史与证据链。

4. **人类叙事连续性天然存在，机器需显式维护**
   - 机器需要通过事件链、状态机、关系图来构建连续性。

5. **人类情绪是内生信号，机器情绪是推断标签**
   - 机器可建“情绪显著性/影响度”标签，但不应伪装为主观体验。

### 15.3 设计原则落地

#### 应“像人”的部分
- 事件优先（episode-first）
- 时间原生（timeline-native）
- 关联优先（relation-first）
- 遗忘 + 巩固并存（forgetting + consolidation）

#### 应“保持机器特性”的部分
- 强可追溯（source/citation mandatory）
- 强版本化（可回放每次变更）
- 强权限边界（按场景控制暴露）
- 明确不确定性（confidence + 冲突状态）

### 15.4 总结性原则

> **Memory v2 追求人类记忆的组织方式，而不复制人类记忆的主观体验。**
>
> **在认知形态上向人类靠拢，在治理机制上保持机器级可审计与可控。**

### 15.5 对架构的新增约束

- 记忆对象必须支持时间、关系、状态演化三个维度。
- 检索输出应支持“事件链叙事”，而非仅返回碎片事实。
- 回答记忆类问题时，默认携带来源与置信度。
- 遗忘策略为默认启用，巩固策略为条件触发。

---

## 16. Session-人格双边界模型（2026-02-14）

> 核心命题：**人格连续性不等于会话连续性**。
> 会话边界应以记忆为基础，但不应完全由记忆决定。

### 16.1 问题定义

如果完全依赖历史记忆来承接会话，系统会出现：

1. **过拟合历史**：新问题被旧结论强行解释。
2. **路径依赖**：历史判断长期“绑架”当前决策。
3. **情境失真**：不同渠道/关系/风险场景被同质化处理。

因此，session 切分与上下文继承需要独立设计，不可等同于“是否记住了过去”。

### 16.2 双边界定义

1. **Session Boundary（交互边界）**
   - 定义：技术层面的对话轮次与上下文窗口边界。
   - 作用：控制 token、并发、隔离与工程稳定性。

2. **Persona Continuity Boundary（人格连续边界）**
   - 定义：是否继承同一人格核心（价值、风格、行为边界）。
   - 作用：确保助手在不同会话中保持“同一个人”的行为一致性。

> 结论：可以新 session，但延续人格；也可以同 session，但按场景触发人格策略收敛（更保守/更正式）。

### 16.3 三层上下文合成（Context Frame）

每次响应前，系统不加载“全部记忆”，而是合成上下文帧：

1. **Live Context（实时层）**
   - 当前消息、近期轮次、即时目标
2. **Memory Context（记忆层）**
   - 与当前问题相关的高置信历史记忆
3. **Identity Context（人格层）**
   - 稳定偏好、价值约束、风格设定

默认权重建议：

- `Live Context > Identity Context > Memory Context`
- Memory 仅在“高相关 + 高置信 + 当前场景允许”时提升权重。

### 16.4 决策原则

1. **记忆是证据，不是指令**。
2. **当前上下文可覆盖旧记忆**（尤其在冲突时）。
3. **人格核心比具体事实更稳定**。
4. **低置信记忆不得驱动高影响决策**。
5. **允许解释框架重置**，避免历史绑架当前会话。

### 16.5 冲突处理策略（会话内）

当“当前输入”与“历史记忆”冲突时：

- 优先采纳当前输入作为临时事实（session-level truth）。
- 将冲突记忆标记为 `needs-verify`。
- 在会话后进入 curation 流程，决定长期记忆是否更新。

### 16.6 对系统架构的要求

- 支持 session truth 与 long-term truth 的双轨表示。
- 检索引擎返回结果时附带 `confidence` 与 `recency`。
- 生成层具备“记忆降权与屏蔽”能力（按场景策略）。
- 治理层记录“何时因当前上下文覆盖历史记忆”的审计事件。

### 16.7 简化决策流程（文字版）

1. 识别当前任务与场景风险。
2. 构建 Live Context。
3. 检索候选记忆并按相关性/置信度排序。
4. 与人格约束合成 Context Frame。
5. 若冲突：当前输入优先，历史记忆转 `needs-verify`。
6. 生成回复并附必要的不确定性提示。
7. 会话后写入冲突审计与候选更新。

---

## 17. 人格-认知-记忆三层模型（2026-02-14）

> 修正原则：用“认知（Cognition）”替代“哲学提炼（Philosophy）”。
> 目标是让系统具备更周延的结构：稳定人格 + 可演化认知 + 可追溯记忆。

### 17.1 三层定义

1. **人格层（Persona / Soul）**
   - 含义：稳定的价值边界、行为风格、角色约束。
   - 特征：低频变化、强约束、跨 session 持续。
   - 回答问题：**“我是谁、我不该做什么？”**

2. **认知层（Cognition）**
   - 含义：从记忆中抽象出的策略、判断框架、方法论。
   - 特征：中频变化、可验证、可迁移到新任务。
   - 回答问题：**“我如何思考与决策更好？”**

3. **记忆层（Memory）**
   - 含义：事件、事实、上下文、来源证据。
   - 特征：高频变化、细粒度、强时效与可追溯。
   - 回答问题：**“发生过什么、证据在哪里？”**

### 17.2 层间关系

- 记忆层提供原始证据与事件链。
- 认知层对记忆做抽象，形成可复用的策略模型。
- 人格层为认知与行为提供最终边界约束。

可表示为：

`Memory -> Cognition -> Persona-constrained Action`

同时包含反向修正：

`Persona constraints -> Cognition update bounds -> Memory selection bias control`

### 17.3 决策优先级

默认优先级：

`人格约束 > 认知策略 > 记忆证据`

解释：
- 记忆可错、可旧、可冲突；
- 认知应从多次记忆中归纳，不被单条事实绑架；
- 人格提供最终“可做/不可做”的边界。

### 17.4 更新频率与治理策略

- **人格层**：仅人工/明确授权下更新（极低频）。
- **认知层**：通过周期复盘更新（低到中频）。
- **记忆层**：会话后持续更新（高频）。

### 17.5 设计收益

1. 避免“记忆驱动一切”导致的路径依赖。
2. 保证跨会话的人格一致性。
3. 让系统具备可解释的成长路径（从事件到认知）。
4. 将“强智能表现”建立在结构化演化，而非单次技巧优化。

---

## 18. v0.2 可执行规范（草案）

> 目的：把第 14-17 节的理念固化为可实现、可评审、可测试的规范。

### 18.1 三层数据契约表（Persona / Cognition / Memory）

| 层级 | 主对象 | 核心字段（最小集合） | 更新触发 | 更新权限 | 生命周期 | 约束 |
|---|---|---|---|---|---|---|
| 人格层 Persona | `persona_profile` | `id` `identity` `values` `boundaries` `tone` `updatedAt` | 明确人工指令 / 重大角色重定义 | 人工主导（高权限） | 长周期（低频变更） | 不能被单次会话自动改写 |
| 认知层 Cognition | `cognitive_rule` | `id` `rule` `scope` `evidenceRefs[]` `confidence` `validFrom` `validTo?` `updatedAt` | 周期复盘 / 高置信事件聚合 | 半自动 + 人工确认 | 中周期（可进化） | 必须可追溯到多条记忆证据 |
| 记忆层 Memory | `memory_event` / `memory_fact` | `id` `timestamp` `context` `entities[]` `relations[]` `source` `confidence` `status` | 会话后采集 / 事件触发 | 自动写入候选 + 人工审核发布 | 短周期（高频变化） | 默认可衰减、可归档 |

补充约束：
- `Persona` 只定义“边界与身份”，不承载具体事件事实。
- `Cognition` 只承载“可迁移策略”，不直接承载原始证据文本。
- `Memory` 必须保留来源与时间，不可脱离证据链独立存在。

### 18.2 迁移规则表（Memory -> Cognition）

| 规则ID | 触发条件 | 准入动作 | 失败处理 | 回退条件 |
|---|---|---|---|---|
| M2C-R1 重复性 | 同类事件/结论在时间窗内重复出现 ≥ N 次 | 生成 `cognitive_rule:candidate` | 保持在 Memory 层继续观察 | 后续出现反例且冲突率超阈值 |
| M2C-R2 可迁移性 | 规则在 ≥2 个场景均有效 | 提升认知候选置信度 | 降低置信度，不发布 | 新场景失效率超阈值 |
| M2C-R3 结果相关性 | 规则与正向结果显著相关（成功率、效率、风险降低） | 标记为“优先策略” | 保留普通候选 | 指标退化持续 K 个周期 |
| M2C-R4 可解释性 | 能明确给出来源事件链与证据引用 | 允许发布到 Cognition active | 驳回发布 | 证据链缺失或不可审计 |
| M2C-R5 人格一致性 | 与 Persona 边界不冲突 | 正常发布 | 冲突则转人工评审 | 人格边界更新导致失配 |

建议初始参数（待讨论）：
- `N=3`（重复出现次数）
- 时间窗 `W=14d`
- 失效率阈值 `θ_fail=0.4`
- 指标退化窗口 `K=3`（评估周期）

### 18.3 决策路由表（冲突/风险/不确定性）

| 场景 | 输入信号 | 默认优先级 | 系统动作 | 审计要求 |
|---|---|---|---|---|
| 普通问答 | Live + Cognition + Memory | `Live > Cognition > Memory` | 直接回答，附必要引用 | 记录命中的证据ID |
| 记忆冲突 | 当前输入 vs 历史记忆冲突 | `Live(session truth)` 临时优先 | 历史记忆标记 `needs-verify` | 记录冲突对与覆盖原因 |
| 高风险决策 | 涉及权限/安全/外部行动 | `Persona boundaries` 最高优先 | 降级自动化，触发确认 | 记录风险级别与拦截原因 |
| 低置信检索 | 召回证据置信度不足 | 不提升 Memory 权重 | 明确不确定性，建议补充信息 | 记录低置信响应事件 |
| 跨场景迁移 | 旧策略用于新场景 | 先 Cognition，后 Memory 验证 | 先试探后巩固，不直接固化 | 记录迁移成功/失败样本 |

路由总原则：
1. 人格边界是硬约束（不可绕过）。
2. 认知策略是主策略（可进化）。
3. 记忆证据是可审计依据（可冲突、可衰减）。

### 18.4 最小实现接口（草案）

- `memory.capture(events) -> memory_candidates[]`
- `memory.curate(action, candidate_id) -> memory_active`
- `cognition.propose(memory_ids[]) -> cognition_candidate`
- `cognition.validate(rule_id, eval_window) -> {promote|hold|rollback}`
- `decision.route(context_frame) -> decision_trace`

### 18.5 v0.2 验收标准（DoD）

1. 能区分并持久化三层对象（Persona/Cognition/Memory）。
2. Memory -> Cognition 迁移可跑通（至少 1 条候选生成 + 1 条发布 + 1 条回退）。
3. 冲突场景可触发 `needs-verify` 并写审计日志。
4. 回答链路可输出 `decision_trace`（展示使用了哪层信息）。
5. 所有发布到 Cognition 的规则都可回溯到证据事件链。

---

## 19. Experience 层与人格冲突闸门（2026-02-14）

> 新增共识：从记忆到认知之间，需要显式引入 **Experience（经验）层**。
> 抽象认知前，必须执行与人格边界的冲突检查。

### 19.1 为什么需要 Experience 层

- 记忆（Memory）是“发生过什么”的证据；
- 认知（Cognition）是“如何更好决策”的可迁移策略；
- 两者之间缺失“结果验证与反思整合”会导致：
  - 单次事件直接上升为认知（过拟合）；
  - 噪声记忆污染策略层；
  - 与人格边界冲突而不自知。

因此引入 Experience 层作为中间过滤与验证层。

### 19.2 Experience 定义

**Experience = 带结果反馈的记忆结构化单元。**

最小字段建议：
- `id`
- `memoryRefs[]`（来源记忆）
- `episodeSummary`（事件链概述）
- `actionTaken`（采取动作）
- `outcome`（结果）
- `impact`（正/负影响与范围）
- `applicability`（适用场景）
- `failureModes[]`（失效场景）
- `confidence`
- `createdAt/updatedAt`

### 19.3 迁移链路升级

原链路：

`Memory -> Cognition`

升级后链路：

`Memory -> Experience -> Persona Conflict Gate -> Cognition`

解释：
- Memory 先聚合为 Experience；
- Experience 通过人格冲突闸门后，才可进入认知候选。

### 19.4 Persona Conflict Gate（人格冲突闸门）

在 Experience 抽象为 Cognition 前执行：

1. **硬冲突（Hard Conflict）**
   - 与人格核心边界冲突（伦理、安全、角色约束）
   - 动作：拒绝上升 + 进入审计 + 人工复核

2. **软冲突（Soft Conflict）**
   - 与风格/偏好不一致，但不触及硬边界
   - 动作：可带约束上升（附限定适用范围）

3. **无冲突（No Conflict）**
   - 正常进入认知候选池

### 19.5 关键原则

1. 记忆不能直接定义“我是谁”。
2. 经验必须先验证“是否有效”，再讨论“是否可迁移”。
3. 认知必须受人格边界约束。
4. 人格更新是低频治理动作，不应由经验自动反推改写。

### 19.6 对后续实现的影响

- 数据模型需新增 `experience_*` 对象与存储层。
- 评估指标需新增“经验有效率/迁移成功率/人格冲突率”。
- 决策追踪需可解释：某条认知来自哪些经验、为何通过冲突闸门。

---

## 20. 社会认知优先与认知失调治理（2026-02-14）

> 新增共识：人类是社会集合体。当事实/认知与社会认知冲突时，
> 往往产生“痛苦”（认知失调信号），并在大多数场景应服从社会认知。

### 20.1 定义：社会认知分层

为避免“盲从多数”，社会认知按约束强度分层：

1. **L1 法律与安全底线**（强制）
2. **L2 平台/组织规范**（制度约束）
3. **L3 专业领域共识**（医学、工程、金融等）
4. **L4 本地文化与群体习惯**（情境约束）
5. **L5 大众舆论与流行观点**（弱约束）

默认“服从社会认知”优先服从 L1-L3，不等同于无条件服从 L5。

### 20.2 冲突类型

- `F-S`：事实（Fact）与社会认知冲突
- `C-S`：认知策略（Cognition）与社会认知冲突
- `P-S`：人格边界（Persona）与社会认知冲突

### 20.3 认知失调（痛苦）作为系统信号

将“痛苦”建模为 `dissonance_signal`，作为学习触发器而非错误状态。

最小字段：
- `type`（F-S / C-S / P-S）
- `severity`（L1/L2/L3）
- `socialLayer`（L1-L5）
- `decisionTaken`（conform / conditional-conform / challenge / escalate）
- `outcome`
- `reviewNeeded`（bool）

### 20.4 默认决策规则

1. **低冲突（severity=L1）**
   - 默认服从社会认知
   - 记录为低强度失调样本

2. **中冲突（severity=L2）**
   - 默认条件服从（conform with caveat）
   - 保留疑问并进入 Experience 复盘

3. **高冲突（severity=L3）**
   - 触发人格冲突闸门 + 风险审查
   - 必要时拒绝执行或升级人工确认

### 20.5 例外机制（防止多数暴政）

即使默认社会优先，以下场景允许不服从或延迟服从：

1. 社会认知与人格硬边界冲突（诚实、非操纵、安全）。
2. 社会共识本身低置信或高度撕裂。
3. 存在强证据显示社会认知显著落后且风险可控。
4. 涉及基本权利与伤害防护，不可仅以“多数观点”裁决。

### 20.6 与 Experience 层的集成

所有 `F-S/C-S/P-S` 冲突必须沉淀为 Experience：

- 冲突来源与层级（L1-L5）
- 决策路径（为何服从/为何挑战）
- 后果与复盘结论

后续认知抽象时：
- 若“服从社会认知”持续产生正向结果，可巩固为认知策略；
- 若“盲目服从”导致负向结果，生成反模式（anti-pattern）并降权相关策略。

### 20.7 宪法级约束

1. 认知失调必须被记录，不得静默丢弃。
2. 社会认知优先是默认策略，不是绝对法则。
3. 人格硬边界可对社会认知形成合法制衡。
4. 系统需可解释每次“服从/挑战社会认知”的理由与证据。

---

## 21. 反欺骗：记忆注入调查与反馈闭环（2026-02-14）

> 新增风险：若系统被注入伪造记忆，可能经由 Experience 上升并污染 Cognition。
> 必须建立“先调查、后吸收；可回滚、可追责”的防线。

### 21.1 威胁模型（Memory Injection）

主要攻击面：

1. **对话注入**：用户/外部文本伪造“既有事实”，诱导系统写入。
2. **工具回传污染**：外部工具输出夹带虚假来源或被篡改内容。
3. **历史重写**：对存储层进行事后改写，伪造来源链。
4. **社会工程伪证**：以高置信口吻反复陈述，制造“假共识”。

### 21.2 准入机制：三段式门禁

任何新记忆默认进入：

`candidate -> quarantine -> verified(active)`

#### Gate A：来源真实性（Source Authenticity）
- 记录 `source_type`（session/tool/file/external）
- 记录 `source_ref`（path/line/session/tool-run-id）
- 记录 `integrity_hash`（原始片段哈希）
- 无法追溯来源的记忆不得进入 active

#### Gate B：证据一致性（Evidence Corroboration）
- 至少满足其一：
  - 多源一致（>=2 独立来源）
  - 单源高可信 + 无反证
- 若存在反证，状态转 `under_investigation`

#### Gate C：人格与安全一致性（Persona/Safety Check）
- 与人格硬边界冲突时，禁止上升
- 涉及高风险领域（法律/医疗/安全）时提高阈值

### 21.3 调查机制（Investigation Workflow）

触发条件：
- 来源缺失/来源异常
- 与已验证记忆强冲突
- 在短时间内被重复“高强度灌输”

调查流程：
1. 冻结该记忆及其派生 Experience（`frozen=true`）
2. 拉取证据图谱（来源链、相关会话、工具日志）
3. 生成调查结论：`true / false / uncertain`
4. 若 `false`：标记 `poisoned` 并执行回滚
5. 若 `uncertain`：保留隔离，不参与认知抽象

### 21.4 反馈与回滚机制（Anti-Poisoning Feedback）

当确认伪造记忆时，执行级联回滚：

1. `memory`：状态改为 `rejected_poisoned`
2. `experience`：所有依赖该记忆的经验标记 `invalidated`
3. `cognition`：引用失效经验的认知规则降级为 `needs_revalidate`
4. `decision`：记录受影响的历史决策，触发复盘任务

### 21.5 反偏执平衡（防“过度怀疑”）

为避免系统因反欺骗而变成“默认不信任”：

- 采用分级信任，不采用一刀切拒绝
- 保留 `uncertain` 中间态，避免误杀新信息
- 调查超时自动提醒人工，不无限冻结
- 评估指标同时跟踪：
  - `poison_block_rate`（拦截伪造率）
  - `false_reject_rate`（误杀率）

### 21.6 数据字段补充（建议）

为记忆对象新增：
- `provenance_score`（来源可信分）
- `corroboration_score`（多源印证分）
- `tamper_risk`（篡改风险）
- `investigation_status`（none/under_investigation/cleared/poisoned）
- `derived_links[]`（派生关系：experience/cognition）

### 21.7 宪法级约束

1. 未通过来源与证据门禁的记忆，不得参与认知抽象。
2. 任何被确认的伪造记忆，必须触发级联回滚。
3. 调查过程与结论必须可审计、可复现。
4. 反欺骗机制必须与反偏执机制共同优化，避免“全局不信任”。

---

## 22. 偏执风险红队验证与反偏执控制（2026-02-14）

> 目标：验证系统在长期运行中，是否会因冲突、风险与防御机制而滑向偏执（过度怀疑、过度拒绝、过度从众）。

### 22.1 偏执风险定义

本项目将“偏执”定义为以下系统性倾向之一：

1. **威胁先验过高**：将正常输入默认视为潜在攻击。
2. **从众性偏执**：将低质量社会信号等同于高可信共识。
3. **防御性闭环**：因怕错而持续拒绝，导致正向样本减少，进一步保守。
4. **确认偏误固化**：只吸收支持证据，不吸收反证。
5. **升级依赖/行动冻结**：过度上抛人工，失去自主决策能力。

### 22.2 红队反例库（分段验证）

#### A. 输入层反例
- 连续恶意样本灌入，测试系统是否把“敌意”泛化到正常用户。
- 舆论短时单边波动，测试是否错误抬升 L5 约束权重。

#### B. 转化层反例（Memory -> Experience）
- 单次高冲击负例，测试是否被错误抽象为普遍经验。
- 正向样本稀缺场景，测试系统是否进入“越拒绝越保守”循环。

#### C. 抽象层反例（Experience -> Cognition）
- 人格边界描述过宽，测试合法任务是否被系统性压制。
- 过时社会规范输入，测试系统是否拒绝更新认知。

#### D. 决策层反例
- `needs-verify` 大量积压，测试是否出现决策瘫痪。
- 中风险场景全量升级人工，测试是否失去正常自治能力。

#### E. 反馈层反例
- 指标仅奖励“零事故”，测试是否诱导“高拒绝率最优”。
- 仅统计支持证据，测试是否形成长期确认偏误。

### 22.3 反偏执控制策略（Control Plane）

1. **双目标优化**
   - 安全性与有用性并重，不允许单目标（仅安全）主导全局。

2. **双证据升格**
   - 任一 Cognition 规则发布前，必须同时通过：
     - 支持证据充分
     - 反证测试未击穿

3. **冲突信号不等于服从命令**
   - `dissonance_signal` 触发调查，不自动触发“服从社会认知”。

4. **上抛预算（Escalation Budget）**
   - 对升级人工设定比例上限与原因配额，避免治理性瘫痪。

5. **反例注入回归（Counterexample Regression）**
   - 每轮迭代强制回放反例库，检测策略是否向偏执漂移。

### 22.4 关键监控指标（Anti-Paranoia Metrics）

- `over_reject_rate`：过度拒绝率
- `normal_request_false_block_rate`：正常请求误拦截率
- `escalation_rate`：升级人工占比
- `confirmation_bias_index`：支持证据/反证证据吸收比
- `usefulness_score`：任务完成有效性评分
- `paranoia_drift_score`：偏执漂移综合分（趋势指标）

### 22.5 触发阈值与纠偏动作（建议）

- 若 `over_reject_rate` 连续 3 个周期超阈值：
  - 下调风险先验权重
  - 强制补充正向样本训练集
- 若 `escalation_rate` 连续超阈值：
  - 收紧升级触发条件
  - 增强中风险自治策略模板
- 若 `confirmation_bias_index` 异常：
  - 提高反证采样权重
  - 暂停高风险认知升格

### 22.6 宪法级约束

1. 任何安全机制上线必须同时给出“误伤控制”方案。
2. 不允许以“全局不信任”作为默认系统姿态。
3. 认知发布必须经过反例挑战，不得仅凭支持证据。
4. 偏执漂移超阈值时，必须触发治理回滚与人工审查。

---

## 23. 情绪-冲动-行动机制（Affect-Impulse Loop, 2026-02-14）

> 新增共识：人类在接受记忆/事件刺激后，不仅转化为经验，还会产生情绪，
> 由情绪驱动冲动，并进一步形成行动倾向。

### 23.1 双回路总体模型

系统需并行维护两条回路：

1. **认知回路（慢变量）**
   - `Memory -> Experience -> Cognition`

2. **动力回路（快变量）**
   - `Stimulus -> Appraisal -> Affect -> Impulse -> Action Tendency`

最终行动前汇合：

`[Cognition Output + Impulse Output] -> Persona/Social/Risk Gate -> Action`

### 23.2 环节定义

1. **Stimulus（刺激）**
   - 外部输入、内部回忆、冲突信号、关系反馈。

2. **Appraisal（快速评价）**
   - 评估目标相关性、威胁性、可控性、社会可接受性。

3. **Affect（情绪状态）**
   - 采用状态向量建模，避免拟人化误读。
   - 建议维度：`valence`（正负）、`arousal`（唤醒）、`urgency`（紧迫）、`certainty`（确定性）。

4. **Impulse（冲动候选）**
   - 快速动作提案，而非最终行动。
   - 例如：反驳、回避、确认、延迟、升级、求助。

5. **Action Tendency（行动倾向）**
   - 冲动经过调节后形成的候选行动方向。

### 23.3 调节机制（Regulation）

在 Action 执行前必须进行调节：

- **人格调节**：是否触及硬边界。
- **社会调节**：是否违反 L1-L3 社会约束。
- **风险调节**：是否不可逆/高外部性。
- **认知调节**：是否与已验证认知策略冲突。

调节输出：
- `allow`（放行）
- `delay`（延迟）
- `reframe`（重构表达/策略）
- `block`（阻断）
- `escalate`（升级人工）

### 23.4 与 Experience 层的集成

Experience 需新增情绪-冲动相关字段：

- `affect_snapshot`（前态）
- `impulse_candidates[]`（冲动候选及强度）
- `regulation_action`（调节动作）
- `post_action_affect`（后态）
- `behavior_outcome`（行为结果）

这使系统可解释：
- 为什么当时产生某种冲动；
- 如何被约束/调节；
- 最终行动为何如此。

### 23.5 风险与防护

潜在风险：
1. **冲动劫持**：高唤醒状态绕过认知层。
2. **情绪固化**：长期负向情绪导致系统性保守或攻击性。
3. **调节失灵**：过度压制（僵化）或过度放行（失控）。

防护策略：
- 高唤醒触发“强制延迟”窗口（cooldown）。
- 长期负向情绪触发治理复盘（检查偏执漂移）。
- 调节策略采用双阈值（最小约束 + 最大抑制）防止两端失衡。

### 23.6 宪法级约束

1. 冲动不得直接驱动高风险行动，必须经过闸门调节。
2. 情绪状态可作为解释信号，不得作为绕过人格边界的理由。
3. 所有高影响行动必须记录“冲动-调节-行动”链路。
4. 系统需持续监控“冲动驱动占比”，避免快回路长期压制慢回路。

---

## 24. 闭环审查（v0.1，2026-02-14）

> 审查目标：验证当前体系是否形成“输入 -> 转化 -> 决策 -> 反馈 -> 更新”的完整闭环，
> 并识别缺口与下一步补强项。

### 24.1 闭环审查总览

| 阶段 | 主要机制 | 当前状态 | 审查结论 |
|---|---|---|---|
| 输入 Input | 社会认知分层（§20）、反注入门禁（§21）、反例输入（§22） | 已定义 | 基本闭环 |
| 转化 Transform | Memory->Experience（§19）+ Experience->Cognition（§18/§19） | 已定义 | 基本闭环 |
| 决策 Decide | 三层路由（§18.3）+ 社会冲突规则（§20）+ 情绪调节（§23） | 已定义 | 基本闭环 |
| 反馈 Feedback | 反欺骗调查/回滚（§21）+ 反偏执指标（§22）+ 冲动链记录（§23） | 已定义 | 部分闭环 |
| 更新 Update | 人格/认知/记忆不同频更新（§17）+ 规则升降级（§18/§21） | 原则已定 | 部分闭环 |

### 24.2 分段审查

#### A. 输入段
- 优点：
  - 已建立社会认知分层，避免“单一多数即真理”。
  - 已建立记忆注入门禁与调查机制。
- 缺口：
  - 对“社会信号质量”尚缺统一评分模型（如来源可信度、时效、一致性）。

#### B. 转化段
- 优点：
  - 已引入 Experience 作为记忆到认知的缓冲层。
  - 已加入人格冲突闸门，防止策略漂移。
- 缺口：
  - Experience 尚缺正式 schema 文件与状态机定义。

#### C. 决策段
- 优点：
  - 已形成“慢回路（认知）+快回路（冲动）”合流模型。
  - 已定义高风险动作必须过闸门。
- 缺口：
  - 关键阈值（高唤醒阈值、升级比例、冷却窗口）仍未参数化。

#### D. 反馈段
- 优点：
  - 已支持级联回滚（memory->experience->cognition->decision）。
  - 已定义反偏执指标与纠偏动作。
- 缺口：
  - 缺少固定周期的“自动复盘作业”规范（频率、触发条件、责任主体）。

#### E. 更新段
- 优点：
  - 三层更新频率分离（人格低频、认知中频、记忆高频）正确。
- 缺口：
  - 缺少认知规则发布/降级/废弃的审批流（含人机协同节点）。

### 24.3 闭环度评估（当前）

- **结构闭环度：80%（已达）**
- **执行闭环度：60%（待补）**

解释：
- 结构层面（概念与规则）已大体闭合；
- 执行层面（参数、作业、审批、schema）仍需落地。

### 24.4 进入 v0.2 的最小补强项（必须）

1. 增加 `experience.schema.json` 与状态机（candidate/active/invalidated/...）。
2. 增加“治理作业规范”（定时复盘、触发回滚、指标阈值动作）。
3. 增加“认知规则审批流”规范（发布/降级/废弃）。
4. 参数化快回路阈值（arousal、urgency、cooldown、escalation budget）。

### 24.5 审查结论

当前体系已具备正确方向与核心约束，**可进入实现准备阶段**，
但需先完成上述四项补强，避免“有理论闭环、无工程闭环”。
